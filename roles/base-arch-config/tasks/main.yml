---
- name: upgrade all packages
  become: yes
  become_user: root
  pacman:
    update_cache: yes
    upgrade: yes

# Install base packages
- include: arch/packages/yay.yml
- include: arch/packages/bash.yml
  when: shell == 'bash'

- include: arch/packages/zsh.yml
  when: shell == 'zsh'

# - include: arch/packages/acpid.yml
- include: arch/packages/htop.yml
- include: arch/packages/dbus.yml
- include: arch/packages/avahi.yml
# - include: arch/packages/cups.yml
# - include: arch/packages/cronie.yml
- include: arch/packages/timesync.yml
# - include: arch/packages/rsync.yml
# - include: arch/packages/ethtool.yml
# - include: arch/packages/socat.yml
- include: arch/packages/docker.yml
- include: arch/packages/kubernetes-binaries.yml
- include: arch/packages/cni-plugins.yml

- name: enable colorful output in pacman.conf
  become: yes
  become_user: root
  replace:
    path: /etc/pacman.conf
    regexp: '^#\s*Color.*$'
    replace: 'Color'

- name: Reboot to activate changes
  become: yes
  become_user: root
  reboot:

- name: Wait until hosts rebooted
  become: yes
  become_user: root
  wait_for_connection:  
    timeout: 120